# Locale / input
cdrom
lang en_US.UTF-8
keyboard --vckeymap=be --xlayouts='be'

# Networking
network --bootproto=dhcp --device=eno1 --activate

# Time
timezone Europe/Brussels 

# EULA / Firstboot
eula --agreed
firstboot --disable

# Root locked; wheel user with hashed password (SHA-512)  ❗ replace hash
rootpw --lock
user --name=dvbrusselen --groups=wheel --iscrypted --password '$6$8VXEUBshf/.9OcIB$GqMiUVLSokC3C2AGBYT37OOkRJed8ug./qcik928yRycyDteitBNZK1yumrJJjM82gcnPh5eu6NzQnPJfR5Ps0' --gecos="dvbrusselen"


# SELinux
selinux --enforcing

bootloader --timeout=5 --append="audit=1 selinux=1 enforcing=1 loglevel=3"

# Disks
# storage --bootdrive=sda
clearpart --all --initlabel
zerombr

# UEFI
part /boot/efi --fstype=efi --size=600 --fsoptions="umask=0077,shortname=winnt"
part /boot     --fstype=xfs --size=1024

# LVM
part pv.01 --size=1 --grow
volgroup vg0 pv.01

# Logical volumes (tightened mounts)
logvol /            --vgname=vg0 --size=12000 --name=lv_root --fstype=xfs
logvol /var         --vgname=vg0 --size=6000  --name=lv_var  --fstype=xfs
logvol /var/log     --vgname=vg0 --size=3000  --name=lv_log  --fstype=xfs --fsoptions="nodev,nosuid"
logvol /var/log/audit --vgname=vg0 --size=1024 --name=lv_audit --fstype=xfs --fsoptions="nodev,nosuid"
logvol /home        --vgname=vg0 --size=20000 --name=lv_home --fstype=xfs --fsoptions="nodev,nosuid"
logvol /opt         --vgname=vg0 --size=2000  --name=lv_opt  --fstype=xfs --fsoptions="nodev"
logvol /tmp         --vgname=vg0 --size=2000  --name=lv_tmp  --fstype=xfs --fsoptions="nodev,nosuid,noexec"
logvol /var/tmp     --vgname=vg0 --size=2000  --name=lv_vartmp --fstype=xfs --fsoptions="nodev,nosuid,noexec"
logvol swap         --vgname=vg0 --size=4096  --name=lv_swap --fstype=swap


# ===================== Packages =====================
# Let op: bij offline/DVD moeten ALLE pakketten hieronder op de DVD staan.
%packages --excludedocs
@core
@standard
@hardware-support
dracut-live
gnome-session
gnome-terminal
nautilus
xinit
sudo
bash-completion
git
firewalld
aide
audit
dnf-automatic
chrony
policycoreutils
openssh-server
crudini            
%end

# Post – hardening
%post --log=/root/kickstart-post.log --erroronfail

# Set graphical default and enable key services
systemctl enable firewalld
systemctl enable auditd
systemctl enable dnf-automatic.timer
systemctl enable chronyd

# SSH hardening (Protocol directive is obsolete – don’t add it)
sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/^#\?UseDNS.*/UseDNS no/' /etc/ssh/sshd_config
# If you still want to allow passwords initially, flip the line above after first boot.

# Authselect with faillock (locks accounts after N failures)
authselect select sssd with-faillock --force
authselect enable-feature with-pwhistory
authselect apply-changes

# pwquality baseline
crudini --set /etc/security/pwquality.conf '' minlen 14
crudini --set /etc/security/pwquality.conf '' dcredit -1
crudini --set /etc/security/pwquality.conf '' ucredit -1
crudini --set /etc/security/pwquality.conf '' lcredit -1
crudini --set /etc/security/pwquality.conf '' ocredit -1

# journald persistent logs
sed -i 's/^#\?Storage=.*/Storage=persistent/' /etc/systemd/journald.conf

# GNOME idle/lock policy + lock it
mkdir -p /etc/dconf/db/local.d /etc/dconf/db/local.d/locks
cat > /etc/dconf/db/local.d/00-screensaver <<'EOF'
[org/gnome/desktop/session]
idle-delay=uint32 900

[org/gnome/desktop/screensaver]
lock-delay=uint32 0
lock-enabled=true
EOF
cat > /etc/dconf/db/local.d/locks/00-screensaver <<'EOF'
/org/gnome/desktop/session/idle-delay
/org/gnome/desktop/screensaver/lock-delay
/org/gnome/desktop/screensaver/lock-enabled
EOF
dconf update

# IPv6 policy (choose one approach)
# A) Kernel cmdline only: add ipv6.disable=1 to bootloader (not recommended if you ever need IPv6)
# B) Sysctl (preferred if you might selectively enable later):
cat > /etc/sysctl.d/99-disable-ipv6.conf <<'EOF'
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
EOF
sysctl --system

# Firewalld: default drop, allow SSH explicitly
firewall-cmd --set-default-zone=drop
firewall-cmd --permanent --zone=drop --add-service=ssh
firewall-cmd --reload

# AIDE initial DB
/usr/sbin/aide --init || true
[ -f /var/lib/aide/aide.db.new.gz ] && mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz

%end

# Reboot after install
#reboot
shutdown
